# Context Contract Document: ADR-001 Remediation

**Generated by**: apex-guardian
**Source ADR**: docs/adr/001-codebase-remediation.md
**Date**: 2026-01-15

---

## Summary

| Metric | Count |
|--------|-------|
| Integration Points | 12 |
| Contracts Documented | 18 |
| Critical Constraints | 24 |
| Potential Conflicts | 3 |
| Gaps Identified | 5 |

### Analysis Scope

```yaml
analysis_scope:
  total_files_in_codebase: 30
  files_analyzed: 22
  zones:
    hot: 12 files (tracker.py, context_helpers.py, research_session.py, orchestrator.py, config*.py, vertical.py, title.py)
    warm: 6 files (types.py, playbook.py, logging_setup.py, prompts/__init__.py)
    cold: 4 files (test files for pattern reference)
  confidence_impact: "High confidence in documented contracts."
```

---

## Phase 1 Contracts: Critical Security and Reliability

### Contract 1.1: StateTracker._save_state Exception Handling

**Location**: `src/research_orchestrator/state/tracker.py:103-110`
**Criticality**: MUST-MATCH

```python
# EXACT copy from source - lines 103-110
except Exception as e:
    self.logger.error(f"Failed to save checkpoint: {e}")
    # Cleanup temp file if it exists
    if 'tmp_path' in locals():
        try:
            os.unlink(tmp_path)
        except:
            pass  # <-- ISSUE: Bare except swallows KeyboardInterrupt
```

**Consumers**:
- `tracker.py:79` - `load_or_initialize()` calls `_save_state()`
- `tracker.py:211` - `mark_complete()` calls `_save_state()`
- `tracker.py:226` - `mark_in_progress()` calls `_save_state()`
- `tracker.py:245` - `mark_failed()` calls `_save_state()`
- `tracker.py:353, 362, 371` - Layer initialization methods

**Critical Constraints**:
- MUST NOT swallow `KeyboardInterrupt`
- MUST NOT swallow `SystemExit`
- MUST log any caught exception before cleanup
- MUST preserve atomic write behavior (temp file + rename)

**Remediation Pattern**:
```python
try:
    os.unlink(tmp_path)
except OSError as cleanup_error:
    self.logger.warning(f"Failed to cleanup temp file {tmp_path}: {cleanup_error}")
```

---

### Contract 1.2: context_helpers.extract_summary File Reading

**Location**: `src/research_orchestrator/prompts/context_helpers.py:119-127`
**Criticality**: MUST-MATCH

```python
# EXACT copy from source - lines 119-127
if 'output_path' in agent_output:
    try:
        output_path = Path(agent_output['output_path'])
        if output_path.exists():
            with open(output_path, 'r', encoding='utf-8') as f:
                content = f.read()
    except Exception:
        pass
```

**Current Signature**:
```python
def extract_summary(agent_output: Dict[str, Any], max_length: int = 500) -> str
```

**Consumers**:
- `context_helpers.py:196` - `format_layer_1_context_for_vertical()`
- `context_helpers.py:228` - `format_layer_2_context_for_title()`
- `playbook.py:229, 236, 246` - `_format_integration_context()`

**Critical Constraints**:
- MUST NOT read files outside output directory (path traversal)
- MUST validate path before reading
- MUST return `"Summary not available"` on failure (not raise)
- MUST preserve max_length truncation behavior

---

## Phase 2 Contracts: Configuration and Cost Accuracy

### Contract 2.1: Model Name Constants

**Current Hardcoded Locations**:

| File | Line | Value |
|------|------|-------|
| `research_session.py` | 27 | `"claude-sonnet-4-20250514"` |
| `config_models.py` | 147 | `"claude-haiku-4-20250514"` (fallback) |
| `config.py` | 65 | `"claude-sonnet-4-20250514"` (default) |

**Required Constants Structure** (new file `utils/constants.py`):
```python
class Models:
    SONNET_4 = "claude-sonnet-4-20250514"
    HAIKU_4 = "claude-haiku-4-20250514"
    OPUS_4 = "claude-opus-4-20250514"
    DEFAULT = HAIKU_4
    HIGH_QUALITY = SONNET_4
```

---

### Contract 2.2: ResearchSession Cost Tracking

**Location**: `src/research_orchestrator/research_session.py:331-347`
**Criticality**: MUST-MATCH

```python
# EXACT copy - assumes 40/60 input/output split (inaccurate)
def _estimate_cost(self, total_tokens: int) -> float:
    input_tokens = int(total_tokens * 0.4)
    output_tokens = int(total_tokens * 0.6)
    input_cost = (input_tokens / 1_000_000) * 3.0
    output_cost = (output_tokens / 1_000_000) * 15.0
    return input_cost + output_cost
```

**Result Schema** (must preserve):
```python
{
    'deliverables': str,
    'conversation': List[Dict],
    'searches_performed': int,
    'total_turns': int,
    'tokens_used': int,
    'estimated_cost_usd': float,  # MUST remain float
    'execution_time_seconds': float,
    'completion_status': Literal['complete', 'max_turns', 'error', 'budget_exceeded']
}
```

---

### Contract 2.3: Config Loading and Validation

**Location**: `src/research_orchestrator/utils/config_models.py:11-56`

**Current Behavior**: No validation, just `yaml.safe_load()`

**Required Config Schema** (from `config.py:43-101` defaults):
```yaml
execution:
  id: str  # Required
verticals: List[str]  # Required, non-empty
title_clusters: List[str]  # Required, non-empty
execution_settings:
  api:
    model: str  # Default: 'claude-sonnet-4-20250514'
    max_tokens: int  # Default: 16000
  budget:
    max_searches: int
    max_cost_usd: float
  # ... other fields with defaults
```

---

## Phase 3 Contracts: Code Quality and Maintainability

### Contract 3.1: Orchestrator Budget Check Pattern

**Duplicated at 4 locations** in `src/research_orchestrator/orchestrator.py`:
- Lines 406-416 (`_execute_agent`)
- Lines 507-517 (`_execute_vertical_agent`)
- Lines 608-618 (`_execute_title_agent`)
- Lines 726-736 (`_execute_playbook`)

**Budget Dict Structure** (lines 88-94):
```python
self.budget = {
    'max_total_searches': budget_config.get('max_searches', 500),
    'max_total_cost_usd': budget_config.get('max_cost_usd', 200.0),
    'current_searches': 0,
    'current_cost_usd': 0.0
}
```

**Proposed Extraction**:
```python
def _update_budget(self, searches: int, cost: float) -> None:
def _check_budget_limits(self) -> None:  # Raises BudgetExceededError
```

---

### Contract 3.2: run_research.py Resume Arguments

**Location**: `src/run_research.py:129-136`

**Current**: Exits with message "Please also provide --config for resume functionality"

**Required**: Accept `--resume <execution_id> --config <path>` and pass execution_id to orchestrator

---

### Contract 3.3: VERTICALS Data Structure

**Location**: `src/research_orchestrator/prompts/vertical.py:15-46`

**TypedDict** (from `types.py:13-18`):
```python
class VerticalConfig(TypedDict):
    name: str
    description: str
    key_regulations: str
    key_challenges: str
```

**Keys**: `'healthcare'`, `'financial_services'`, `'manufacturing'`, `'retail'`, `'technology'`

---

### Contract 3.4: TITLE_CLUSTERS Data Structure

**Location**: `src/research_orchestrator/prompts/title.py:18-49`

**TypedDict** (from `types.py:21-26`):
```python
class TitleClusterConfig(TypedDict):
    name: str
    titles: List[str]
    decision_authority: str
    key_focus: str
```

**Keys**: `'cfo_cluster'`, `'cio_cto_cluster'`, `'vp_it_operations'`, `'procurement'`, `'business_unit'`

---

## Phase 4 Contracts: Operational Excellence

### Contract 4.1: Test Patterns

**Fixture Pattern** (from `test_orchestrator_layers.py`):
```python
@pytest.fixture
def mock_orchestrator(self):
    with patch('research_orchestrator.orchestrator.load_config') as mock_config, \
         patch('research_orchestrator.orchestrator.setup_logging') as mock_logging, \
         patch('research_orchestrator.orchestrator.AsyncAnthropic') as mock_client, \
         patch('os.getenv', return_value='fake-api-key'):
        # ... setup
        yield orchestrator
```

### Contract 4.2: Logging Patterns

**Location**: `src/research_orchestrator/utils/logging_setup.py`

**Logger Name**: `'research_orchestrator'`

**Pattern**:
```python
self.logger.info(f"[{agent_name}] Action description")
self.logger.warning(f"[{agent_name}] Warning message")
self.logger.error(f"[{agent_name}] Error: {e}", exc_info=True)
```

---

## Potential Conflicts

1. **Model Constants vs Existing Defaults** - Update all defaults to use `Models.DEFAULT`
2. **Pydantic vs Dict-based Config** - Use `.model_dump()` for compatibility
3. **YAML Verticals vs In-Code Dict** - Load YAML with fallback to hardcoded dict

---

## Gaps Identified

1. **No Path Base Directory Configuration** - Need base directory for path traversal validation
2. **Cost Estimation Pricing Data Source** - Need pricing data per model
3. **Circuit Breaker State Persistence** - Not specified if state persists across restarts
4. **YAML Load Fallback Behavior** - Silent vs warning log not specified
5. **Resume Config Path Storage** - Deferred to future ADR

---

## Decomposer Guidance

### For Tasks Modifying Exception Handling
```
MUST NOT swallow: KeyboardInterrupt, SystemExit
Replace bare except with: except OSError as e:
```

### For Tasks Adding Constants
```
Create: src/research_orchestrator/utils/constants.py
Update all: research_session.py, config_models.py, config.py, tests
```

### For Tasks Adding Pydantic
```
Maintain backward compatibility with .model_dump()
Match current _validate_config() defaults
```

### For Tasks Extracting Budget Methods
```
Preserve budget dict keys exactly
Raise BudgetExceededError with same message format
```

### For Tasks Externalizing YAML
```
Match TypedDict schemas exactly
Implement fallback to hardcoded dict
```

### For Tasks Adding Circuit Breaker
```
Use logger: logging.getLogger('research_orchestrator')
Format: f"[CircuitBreaker] {service_name}: {message}"
Integrate with ResearchSession._api_call_with_retry()
```

### For Tasks Adding Tests
```
Follow existing @pytest.fixture pattern
Use @pytest.mark.asyncio for async tests
Mock result dict must include all fields
```
